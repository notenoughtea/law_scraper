name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Run tests
        working-directory: ./scraper
        run: |
          go test -v ./...

      - name: Build
        working-directory: ./scraper
        run: |
          go build -v ./cmd/cron/main.go
          go build -v ./cmd/scraper/main.go

  deploy:
    name: Deploy to Server
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Create .env file
        run: |
          cat > .env << EOF
          API_URL=${{ secrets.API_URL }}
          PAGES_STORAGE=./data/pages.json
          MATCHED_DIR=./data/matched
          KEYWORDS=${{ secrets.KEYWORDS }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_SEND_AS_DOCUMENT=true
          CRON_SCHEDULE=${{ secrets.CRON_SCHEDULE }}
          RUN_ON_START=false
          EOF

      - name: Copy files to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
          ssh $SERVER_USER@$SERVER_HOST "mkdir -p /opt/law_scraper"
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹
          scp -r ./* $SERVER_USER@$SERVER_HOST:/opt/law_scraper/
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ .env
          scp .env $SERVER_USER@$SERVER_HOST:/opt/law_scraper/.env

      - name: Deploy with Docker Compose
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            cd /opt/law_scraper
            
            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
            docker-compose down || true
            
            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
            docker-compose rm -f || true
            
            # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¾Ð±Ñ€Ð°Ð·
            docker-compose build
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
            docker-compose up -d
            
            # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
            docker-compose ps
            
            # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸
            docker-compose logs --tail=50
          ENDSSH

      - name: Verify deployment
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          sleep 10
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            cd /opt/law_scraper
            if docker-compose ps | grep -q "Up"; then
              echo "âœ… Deployment successful!"
              docker-compose ps
            else
              echo "âŒ Deployment failed!"
              docker-compose logs --tail=100
              exit 1
            fi
          ENDSSH

      - name: Notify on success
        if: success()
        run: |
          echo "ðŸŽ‰ Deployment to ${{ secrets.SERVER_HOST }} completed successfully!"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment to ${{ secrets.SERVER_HOST }} failed!"

