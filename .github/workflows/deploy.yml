name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –ª—é–±–æ–º –∫–æ–º–º–∏—Ç–µ –≤ main/master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Download dependencies
        working-directory: ./scraper
        run: |
          go mod download
          go mod verify

      - name: Run tests
        working-directory: ./scraper
        run: |
          go test -v ./...

      - name: Build
        working-directory: ./scraper
        run: |
          go build -v ./cmd/cron/main.go
          go build -v ./cmd/scraper/main.go

  deploy:
    name: Deploy to Server
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check secrets
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤..."
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: SSH_PRIVATE_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ GitHub Secrets!"
            echo ""
            echo "üí° –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ:"
            echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ GitHub"
            echo "   2. Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   3. New repository secret"
            echo "   4. Name: SSH_PRIVATE_KEY"
            echo "   5. Value: –≤–∞—à –ø—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á (–≤–µ—Å—å, –≤–∫–ª—é—á–∞—è BEGIN/END)"
            exit 1
          fi
          
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: SERVER_HOST –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ GitHub Secrets!"
            echo "üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: Settings ‚Üí Secrets ‚Üí New secret ‚Üí Name: SERVER_HOST, Value: 77.105.133.231"
            exit 1
          fi
          
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: SERVER_USER –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ GitHub Secrets!"
            echo "üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: Settings ‚Üí Secrets ‚Üí New secret ‚Üí Name: SERVER_USER, Value: root"
            exit 1
          fi
          
          echo "‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"

      - name: Set up SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          set -e
          
          # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
          if [ -z "$SSH_PRIVATE_KEY" ] || [ "$SSH_PRIVATE_KEY" = "null" ]; then
            echo "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: SSH_PRIVATE_KEY –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω"
            exit 1
          fi
          
          if [ -z "$SERVER_HOST" ] || [ "$SERVER_HOST" = "null" ]; then
            echo "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: SERVER_HOST –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω"
            exit 1
          fi
          
          if [ -z "$SERVER_USER" ] || [ "$SERVER_USER" = "null" ]; then
            echo "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: SERVER_USER –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω"
            exit 1
          fi
          
          echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH..."
          echo "   SERVER_HOST: $SERVER_HOST"
          echo "   SERVER_USER: $SERVER_USER"
          
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–ª—é—á –∑–∞–ø–∏—Å–∞–Ω
          if [ ! -s ~/.ssh/id_rsa ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: SSH –∫–ª—é—á –Ω–µ –∑–∞–ø–∏—Å–∞–Ω –≤ —Ñ–∞–π–ª"
            exit 1
          fi
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Ö–æ—Å—Ç –≤ known_hosts (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ SERVER_HOST –Ω–µ –ø—É—Å—Ç–æ–π)
          if [ -n "$SERVER_HOST" ] && [ "$SERVER_HOST" != "null" ]; then
            echo "üîë –î–æ–±–∞–≤–ª—è–µ–º —Ö–æ—Å—Ç $SERVER_HOST –≤ known_hosts..."
            ssh-keyscan -H "$SERVER_HOST" >> ~/.ssh/known_hosts 2>&1 || {
              echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ö–æ—Å—Ç –≤ known_hosts (–ø—Ä–æ–¥–æ–ª–∂–∞–µ–º)"
            }
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ $SERVER_USER@$SERVER_HOST..."
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            "$SERVER_USER@$SERVER_HOST" \
            "echo '‚úÖ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!'" || {
            echo ""
            echo "‚ùå –û—à–∏–±–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è!"
            echo ""
            echo "üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
            echo "   1. SSH_PRIVATE_KEY –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ BEGIN/END)"
            echo "   2. –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
            echo "   3. –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ping $SERVER_HOST"
            echo "   4. SSH —Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
            echo ""
            echo "üí° –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:"
            echo "   ssh root@$SERVER_HOST 'echo test'"
            exit 1
          }

      - name: Create .env file
        run: |
          cat > .env << EOF
          API_URL=${{ secrets.API_URL }}
          PAGES_STORAGE=./data/pages.json
          MATCHED_DIR=./data/matched
          KEYWORDS=${{ secrets.KEYWORDS }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_SEND_AS_DOCUMENT=true
          CRON_SCHEDULE=${{ secrets.CRON_SCHEDULE }}
          RUN_ON_START=false
          PROJECT_ROOT=/app
          MAX_WORKERS=${{ secrets.MAX_WORKERS }}
          EOF
      
      - name: Create deployment info file
        run: |
          cat > .deployment_info << EOF
          COMMIT_HASH=${{ github.sha }}
          COMMIT_AUTHOR=${{ github.actor }}
          COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s' 2>/dev/null || echo 'N/A')
          DEPLOY_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          BRANCH=${{ github.ref_name }}
          WORKFLOW_RUN=${{ github.run_number }}
          EOF

      - name: Copy files to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          set -e  # –ü—Ä–µ—Ä—ã–≤–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
          
          echo "üìÅ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST \
            "mkdir -p /opt/law_scraper/scraper /opt/law_scraper/data"
          
          echo "üì¶ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º scp –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ (rsync –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
          # –ö–æ–ø–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          echo "   ‚Üí –ö–æ–ø–∏—Ä—É–µ–º scraper/..."
          scp -r -o StrictHostKeyChecking=no ./scraper/* $SERVER_USER@$SERVER_HOST:/opt/law_scraper/scraper/ || {
            echo "‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è scraper/"
            exit 1
          }
          
          echo "   ‚Üí –ö–æ–ø–∏—Ä—É–µ–º Dockerfile –∏ docker-compose.yml..."
          scp -o StrictHostKeyChecking=no Dockerfile $SERVER_USER@$SERVER_HOST:/opt/law_scraper/ || true
          scp -o StrictHostKeyChecking=no docker-compose.yml $SERVER_USER@$SERVER_HOST:/opt/law_scraper/ || true
          
          echo "   ‚Üí –ö–æ–ø–∏—Ä—É–µ–º .env..."
          if [ -f .env ]; then
            scp -o StrictHostKeyChecking=no .env $SERVER_USER@$SERVER_HOST:/opt/law_scraper/.env || {
              echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å .env"
            }
          else
            echo "‚ö†Ô∏è –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
          fi
          
          echo "   ‚Üí –ö–æ–ø–∏—Ä—É–µ–º .deployment_info..."
          if [ -f .deployment_info ]; then
            scp -o StrictHostKeyChecking=no .deployment_info $SERVER_USER@$SERVER_HOST:/opt/law_scraper/.deployment_info || {
              echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å .deployment_info"
            }
          fi
          
          echo "‚úÖ –§–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏—Å—å
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST \
            "ls -la /opt/law_scraper/scraper/go.mod && echo '‚úÖ go.mod –Ω–∞–π–¥–µ–Ω'" || {
            echo "‚ùå –û—à–∏–±–∫–∞: go.mod –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!"
            exit 1
          }

      - name: Deploy with Docker Compose
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST bash << 'ENDSSH'
            set -e  # –ü—Ä–µ—Ä—ã–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
            set -x  # –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω—è–µ–º—ã–µ –∫–æ–º–∞–Ω–¥—ã
            
            cd /opt/law_scraper || {
              echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ /opt/law_scraper"
              exit 1
            }
            
            echo "üì¶ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç—ã –≤ Go —Ñ–∞–π–ª–∞—Ö..."
            if [ -d "scraper/internal" ]; then
              cd scraper
              find . -name "*.go" -type f -exec sed -i 's|lawScraper/scraper/internal|github.com/notenoughtea/law_scraper/internal|g' {} + 2>/dev/null || true
              find . -name "*.go" -type f -exec sed -i 's|"lawScraper/|"github.com/notenoughtea/law_scraper/|g' {} + 2>/dev/null || true
              cd ..
            fi
            
            echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker-compose down || true
            
            echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ –æ–±—Ä–∞–∑—ã..."
            docker-compose rm -f || true
            docker system prune -f || true
            
            echo "üî® –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑..."
            if ! docker-compose build --no-cache; then
              echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–∞!"
              exit 1
            fi
            
            echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            if ! docker-compose up -d; then
              echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤!"
              docker-compose logs
              exit 1
            fi
            
            echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (15 —Å–µ–∫—É–Ω–¥)..."
            sleep 15
            
            echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker-compose ps
            
            echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
            docker-compose logs --tail=50
          ENDSSH

      - name: Verify deployment
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          sleep 5
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST bash << 'ENDSSH'
            set -e
            
            cd /opt/law_scraper
            
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            if docker-compose ps | grep -q "Up"; then
              echo "‚úÖ Deployment successful!"
              echo ""
              echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
              docker-compose ps
              echo ""
              echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
              docker-compose logs --tail=30
            else
              echo "‚ùå Deployment failed!"
              echo ""
              echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
              docker-compose ps
              echo ""
              echo "üìã –ü–æ–ª–Ω—ã–µ –ª–æ–≥–∏:"
              docker-compose logs --tail=100
              exit 1
            fi
          ENDSSH

      - name: Notify on success
        if: success()
        run: |
          echo "üéâ Deployment to ${{ secrets.SERVER_HOST }} completed successfully!"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment to ${{ secrets.SERVER_HOST }} failed!"

